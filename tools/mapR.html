<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasteland Map Renderer 2.0</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 10px; font-weight: 300; letter-spacing: 1px; color: #39ff14; text-shadow: 0 0 10px rgba(57, 255, 20, 0.5); }
        
        .controls {
            margin-bottom: 20px;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #388E3C;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background-color: #2E7D32; }
        
        button.secondary { background-color: #1976D2; }
        button.secondary:hover { background-color: #1565C0; }

        #status { 
            margin-left: 15px; 
            font-size: 0.9em; 
            color: #aaa; 
            font-family: monospace; 
        }
        
        #canvas-wrapper {
            border: 4px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: auto;
            max-width: 95vw;
            max-height: 80vh;
            background: #000;
        }

        canvas {
            display: block;
            image-rendering: pixelated; /* Wichtig für scharfe Pixel-Grafik */
        }
    </style>
</head>
<body>

    <h1>PIP-BOY 3003: WORLD MAP RENDERER</h1>
    
    <div class="controls">
        <button onclick="renderFullMap()">Karte generieren (Neu)</button>
        <button class="secondary" onclick="downloadMap()">Download PNG</button>
        <span id="status">Bereit (Lade Skripte...)</span>
    </div>

    <div id="canvas-wrapper">
        <canvas id="worldCanvas"></canvas>
    </div>

    <script src="../game/game_world_gen.js"></script>

    <script>
    /**
     * KONFIGURATION
     */
    const CONFIG = {
        sectorsX: 10,
        sectorsY: 10,
        sectorSize: 50, // Tiles pro Sektor
        pixelSize: 4    // Pixel pro Tile im Bild
    };

    // Mapping Zeichen -> Farben
    const COLOR_MAP = {
        '.': '#3e3e3e', // Boden (Dunkles Grau/Braun)
        '#': '#111111', // Ruine (Fast Schwarz)
        't': '#2e5a2e', // Wald (Dunkelgrün)
        '^': '#555555', // Berg (Grau)
        '~': '#1e3c72', // Wasser (Tiefblau)
        '=': '#1a1a1a', // Straße (Asphalt)
        '+': '#8B4513', // Brücke (Holz)
        
        // POIs
        'V': '#FFD700', // Vault (Gold)
        'C': '#FF4500', // Stadt (Rot-Orange)
        'S': '#9370DB', // Shrine (Lila)
        
        // Dungeons (Neu)
        'H': '#000000', // Höhle (Schwarz)
        'A': '#556B2F', // Militär (Oliv)
        'R': '#8B0000', // Raider (Dunkelrot)
        'K': '#4682B4', // Funkturm (Stahlblau)
        
        'default': '#ff00ff' // Fehler (Magenta)
    };

    const canvas = document.getElementById('worldCanvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');

    // Init Canvas Größe
    const totalWidth = CONFIG.sectorsX * CONFIG.sectorSize * CONFIG.pixelSize;
    const totalHeight = CONFIG.sectorsY * CONFIG.sectorSize * CONFIG.pixelSize;
    canvas.width = totalWidth;
    canvas.height = totalHeight;

    /**
     * RENDER LOGIK
     */
    async function renderFullMap() {
        if (typeof WorldGen === 'undefined') {
            statusEl.textContent = "FEHLER: game_world_gen.js nicht geladen!";
            statusEl.style.color = "red";
            return;
        }

        statusEl.textContent = "Generiere Welt...";
        statusEl.style.color = "#FFA500";

        // Neuen Seed setzen für eine frische Welt
        const seed = Date.now();
        WorldGen.setSeed(seed);
        console.log("Rendering World Seed:", seed);

        setTimeout(() => {
            const startTime = performance.now();
            let tilesCount = 0;

            // --- HAUPTSCHLEIFE ---
            for (let sy = 0; sy < CONFIG.sectorsY; sy++) {
                for (let sx = 0; sx < CONFIG.sectorsX; sx++) {
                    
                    let sectorMap;
                    try {
                        // FIX: Wir übergeben jetzt SX und SY statt Biome!
                        // Dadurch funktionieren die globalen Flüsse.
                        sectorMap = WorldGen.createSector(CONFIG.sectorSize, CONFIG.sectorSize, sx, sy);
                    } catch (e) {
                        console.error(`Fehler in Sektor ${sx},${sy}:`, e);
                        sectorMap = Array(CONFIG.sectorSize).fill(Array(CONFIG.sectorSize).fill('.'));
                    }

                    // Zeichnen
                    for (let ly = 0; ly < CONFIG.sectorSize; ly++) {
                        for (let lx = 0; lx < CONFIG.sectorSize; lx++) {
                            const tileChar = sectorMap[ly][lx];
                            
                            ctx.fillStyle = COLOR_MAP[tileChar] || COLOR_MAP['default'];
                            
                            // Globale Pixel Position
                            const globalX = (sx * CONFIG.sectorSize) + lx;
                            const globalY = (sy * CONFIG.sectorSize) + ly;
                            
                            ctx.fillRect(
                                globalX * CONFIG.pixelSize, 
                                globalY * CONFIG.pixelSize, 
                                CONFIG.pixelSize, 
                                CONFIG.pixelSize
                            );
                            tilesCount++;
                        }
                    }
                }
            }
            
            // Grid Overlay (Optional: Sektorgrenzen)
            drawGrid();

            const duration = ((performance.now() - startTime) / 1000).toFixed(2);
            statusEl.textContent = `Fertig! Seed: ${seed} (${duration}s)`;
            statusEl.style.color = "#39ff14";

        }, 50);
    }

    function drawGrid() {
        ctx.strokeStyle = "rgba(0, 255, 0, 0.2)";
        ctx.lineWidth = 1;
        
        // Vertikal
        for (let x = 0; x <= CONFIG.sectorsX; x++) {
            const px = x * CONFIG.sectorSize * CONFIG.pixelSize;
            ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, canvas.height); ctx.stroke();
        }
        // Horizontal
        for (let y = 0; y <= CONFIG.sectorsY; y++) {
            const py = y * CONFIG.sectorSize * CONFIG.pixelSize;
            ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(canvas.width, py); ctx.stroke();
        }
    }

    function downloadMap() {
        const link = document.createElement('a');
        link.download = `wasteland_map_${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
    
    // Auto-Start beim Laden
    window.onload = function() {
        if(typeof WorldGen !== 'undefined') {
            statusEl.textContent = "Bereit. Klicke Generieren.";
        }
    };
    </script>
</body>
</html>
